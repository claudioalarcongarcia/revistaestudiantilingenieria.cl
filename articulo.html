<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Artículo</title>
  <link rel="stylesheet" href="styles.css?v=5">
</head>
<body class="app-bg">

  <!-- Barra superior fija -->
  <header class="app-topbar">
    <div class="app-topbar-inner">
      <div class="app-topbar-title">Revista Estudiantil de Ingeniería</div>
      <nav class="app-topbar-nav">
        <a class="navbtn" href="index.html">Inicio</a>
        <a class="navbtn" href="procesados.html">Procesados</a>
        <a class="navbtn" href="no_procesados.html">No procesados</a>
        <a class="navbtn" href="about.html">Acerca de</a>
      </nav>
    </div>
  </header>

  <main class="app-shell">

    <!-- Izquierda (igual que index) -->
    <aside class="app-col app-left">
      <h1 class="app-h1">Revista Estudiantil de Ingeniería</h1>

      <div class="app-stack">
        <a class="btn2" href="procesados.html">Procesados</a>
        <a class="btn2 ghost" href="no_procesados.html">No procesados</a>
      </div>

      <div class="app-links">
        <a href="about.html">Protocolo editorial</a>
        <a href="procesados.html">Estados editoriales</a>
        <a href="no_procesados.html">Ingreso de nuevos trabajos</a>
        <a href="index.html">Portada</a>
      </div>
    </aside>

    <!-- Centro: detalle del artículo -->
    <section class="app-col app-mid">
      <div class="block">
        <div class="blocktitle">Artículo</div>
        <div id="articleBox" class="latest"></div>
        <div id="articleMsg" class="note"></div>
      </div>

      <div class="block">
        <div class="blocktitle">Citado por</div>
        <div id="citadoPor" class="latest"></div>
        <div id="citadoPorMsg" class="note"></div>
      </div>

      <div class="block">
        <div class="blocktitle">Cita a</div>
        <div id="citaA" class="latest"></div>
        <div id="citaAMsg" class="note"></div>
      </div>
    </section>

    <!-- Derecha (igual que index) -->
    <aside class="app-col app-right">
      <div class="block">
        <div class="blocktitle">Noticias</div>
        <div class="app-links">
          <a href="#" target="_blank" rel="noopener">Ciencia y tecnología</a>
          <a href="#" target="_blank" rel="noopener">Eventos académicos</a>
          <a href="#" target="_blank" rel="noopener">Convocatorias estudiantiles</a>
          <a href="#" target="_blank" rel="noopener">Innovación y emprendimiento</a>
          <a href="#" target="_blank" rel="noopener">Seminarios y conferencias</a>
        </div>
      </div>
    </aside>

  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const ID = (params.get("id") || "").trim();

    const SHEET_ID = "1xWRo_TaaJT83s4n5f7W4Apt9Da3M2Bd0q-UgcpyPnaE";
    const SHEET_NAME = "Hoja 01";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const n = text[i + 1];

        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
        if ((c === "\n" || c === "\r") && !inQuotes) {
          if (c === "\r" && n === "\n") i++;
          row.push(cur); cur = "";
          if (row.some(x => x.trim() !== "")) rows.push(row);
          row = [];
          continue;
        }
        cur += c;
      }
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);

      const headers = rows.shift().map(h => h.trim());
      return rows.map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
    }

    function norm(s){ return (s ?? "").replace(/\s+/g, " ").trim(); }

    function splitIds(s){
      const v = norm(s);
      if (!v) return [];
      // por ahora coma; si usa punto y coma, lo cambiamos aquí
      return v.split(",").map(x => x.trim()).filter(Boolean);
    }

    function itemHTML(d){
      const id = norm(d["Identificador"]);
      const titulo = norm(d["Título"]) || norm(d["Titulo"]) || "Documento";
      const autores = norm(d["Autores"]) || "-";
      const anio = norm(d["Año"]) || "-";
      const estado = norm(d["Estado"]) || "-";

      return `
        <div class="item">
          <div class="itemt"><a href="articulo.html?id=${encodeURIComponent(id)}">${titulo}</a></div>
          <div class="itemm">${autores} · ${anio} · ${estado} · ID ${id}</div>
        </div>
      `;
    }

    function articleHTML(d){
      const id = norm(d["Identificador"]);
      const titulo = norm(d["Título"]) || norm(d["Titulo"]) || "Documento";
      const autores = norm(d["Autores"]) || "-";
      const anio = norm(d["Año"]) || "-";
      const rol = norm(d["Rol"]) || "-";
      const estado = norm(d["Estado"]) || "-";
      const doi = norm(d["DOI"]) || "-";
      const link = norm(d["LINK"]);

      document.title = titulo;

      return `
        <div class="item">
          <div class="itemt">${titulo}</div>
          <div class="itemm"><b>Autores</b> ${autores}</div>
          <div class="itemm"><b>Año</b> ${anio}</div>
          <div class="itemm"><b>Rol</b> ${rol}</div>
          <div class="itemm"><b>Estado</b> ${estado}</div>
          <div class="itemm"><b>DOI</b> ${doi}</div>
          <div class="itemm"><b>ID</b> ${id}</div>
          ${link ? `<div class="itemm"><a href="${link}" target="_blank" rel="noopener">Abrir PDF</a></div>` : ""}
        </div>
      `;
    }

    (async () => {
      const articleBox = document.getElementById("articleBox");
      const articleMsg = document.getElementById("articleMsg");

      const citadoPor = document.getElementById("citadoPor");
      const citadoPorMsg = document.getElementById("citadoPorMsg");

      const citaA = document.getElementById("citaA");
      const citaAMsg = document.getElementById("citaAMsg");

      if (!ID){
        articleMsg.textContent = "Falta parámetro id. Ejemplo: articulo.html?id=100001";
        return;
      }

      try{
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("No se pudo leer el Google Sheet (permiso o nombre de hoja).");
        const csv = await res.text();
        const docs = parseCSV(csv);

        const doc = docs.find(d => norm(d["Identificador"]) === ID);
        if (!doc){
          articleMsg.textContent = `No se encontró el documento con Identificador ${ID}.`;
          return;
        }

        articleBox.innerHTML = articleHTML(doc);
        articleMsg.textContent = "";

        // CITADO POR: todos los docs cuya Citas_internas contiene ID
        const citantes = docs.filter(d => splitIds(d["Citas_internas"]).includes(ID));
        if (citantes.length){
          citadoPor.innerHTML = citantes.map(itemHTML).join("");
          citadoPorMsg.textContent = "";
        } else {
          citadoPor.innerHTML = "";
          citadoPorMsg.textContent = "No existen artículos citantes registrados.";
        }

        // CITA A: ids que este doc cita (si existen)
        const citaIds = splitIds(doc["Citas_internas"]);
        const citados = citaIds
          .map(cid => docs.find(d => norm(d["Identificador"]) === cid))
          .filter(Boolean);

        if (citados.length){
          citaA.innerHTML = citados.map(itemHTML).join("");
          citaAMsg.textContent = "";
        } else {
          citaA.innerHTML = "";
          citaAMsg.textContent = "Este documento no cita artículos internos.";
        }

      } catch(e){
        articleMsg.textContent = e.message;
      }
    })();
  </script>

</body>
</html>
