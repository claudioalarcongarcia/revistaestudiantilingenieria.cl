<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Artículo</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="nav">
    <a href="index.html">Inicio</a>
    <a href="procesados.html">Procesados</a>
    <a href="no_procesados.html">No procesados</a>
  </nav>

  <main class="wrap">
    <section id="main"></section>

    <h2>Análisis</h2>
    <section id="analisis" class="grid"></section>
    <p id="msg" class="msg"></p>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const ID = (params.get("id") || "").trim();

    const SHEET_ID = "1xWRo_TaaJT83s4n5f7W4Apt9Da3M2Bd0q-UgcpyPnaE";
    const SHEET_NAME = "Hoja 01";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const n = text[i + 1];

        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
        if ((c === "\n" || c === "\r") && !inQuotes) {
          if (c === "\r" && n === "\n") i++;
          row.push(cur); cur = "";
          if (row.some(x => x.trim() !== "")) rows.push(row);
          row = [];
          continue;
        }
        cur += c;
      }
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);

      const headers = rows.shift().map(h => h.trim());
      return rows.map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
    }

    function norm(s) { return (s ?? "").replace(/\s+/g, " ").trim(); }

    function parseCitas(s) {
      // acepta vacío, "100001,100002", "100001, 100002"
      const raw = norm(s);
      if (!raw) return [];
      return raw.split(",").map(x => x.trim()).filter(Boolean);
    }

    function escapeHTML(str) {
      return (str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderMain(d) {
      const id = norm(d["Identificador"]);
      const autores = escapeHTML(norm(d["Autores"]));
      const anio = escapeHTML(norm(d["Año"]));
      const titulo = escapeHTML(norm(d["Título"]) || norm(d["Titulo"]));
      const rol = escapeHTML(norm(d["Rol"]));
      const estado = escapeHTML(norm(d["Estado"]));
      const doi = escapeHTML(norm(d["DOI"]));
      const link = norm(d["LINK"]);

      document.title = titulo ? `${titulo}` : "Artículo";

      return `
        <h1>${titulo || "Documento"}</h1>
        <div class="meta">
          <div><b>Identificador</b> ${escapeHTML(id)}</div>
          <div><b>Autores</b> ${autores || "-"}</div>
          <div><b>Año</b> ${anio || "-"}</div>
          <div><b>Rol</b> ${rol || "-"}</div>
          <div><b>Estado</b> ${estado || "-"}</div>
          <div><b>DOI</b> ${doi || "-"}</div>
          ${link ? `<div><a href="${link}" target="_blank" rel="noopener">Abrir documento</a></div>` : ""}
        </div>
      `;
    }

    function renderCard(d) {
      const id = norm(d["Identificador"]);
      const autores = escapeHTML(norm(d["Autores"]));
      const anio = escapeHTML(norm(d["Año"]));
      const titulo = escapeHTML(norm(d["Título"]) || norm(d["Titulo"]));
      const rol = escapeHTML(norm(d["Rol"]));

      return `
        <article class="card">
          <div class="title">
            <a href="articulo.html?id=${encodeURIComponent(id)}">${titulo}</a>
          </div>
          <div class="meta">
            <div><b>Autores</b> ${autores || "-"}</div>
            <div><b>Año</b> ${anio || "-"}</div>
            <div><b>Rol</b> ${rol || "-"}</div>
            <div><b>ID</b> ${escapeHTML(id)}</div>
          </div>
        </article>
      `;
    }

    (async () => {
      const main = document.getElementById("main");
      const analisis = document.getElementById("analisis");
      const msg = document.getElementById("msg");

      if (!ID) {
        msg.textContent = "Falta el parámetro id. Ejemplo: articulo.html?id=100001";
        return;
      }

      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("No se pudo leer el Google Sheet (permiso o nombre de hoja).");

        const csv = await res.text();
        const docs = parseCSV(csv);

        const doc = docs.find(d => norm(d["Identificador"]) === ID);
        if (!doc) {
          msg.textContent = `No se encontró el documento con Identificador ${ID}.`;
          return;
        }

        main.innerHTML = renderMain(doc);

        // "Análisis" = documentos que CITAN a este ID en Citas_internas
        const citantes = docs.filter(d => parseCitas(d["Citas_internas"]).includes(ID));

        if (!citantes.length) {
          analisis.innerHTML = "";
          msg.textContent = "No existen documentos citantes registrados.";
          return;
        }

        analisis.innerHTML = citantes.map(renderCard).join("");
        msg.textContent = "";

      } catch (e) {
        msg.textContent = e.message;
      }
    })();
  </script>
</body>
</html>
